workflows:
  ios-release-no-shorebird:
    name: iOS Release
    environment:
      flutter: stable
      xcode: latest

    scripts:
      - name: ğŸ” Check Flutter environment
        script: flutter doctor -v

      - name: ğŸ“¦ Install dependencies
        script: flutter pub get

      - name: ğŸ§¹ Clean previous builds
        script: flutter clean

      - name: ğŸ”§ Ensure CocoaPods and exclude x86_64
  script: |
    cd ios

    # Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ Podfile, ĞµÑĞ»Ğ¸ ĞµĞ³Ğ¾ ĞµÑ‰Ñ‘ Ğ½ĞµÑ‚
    if [ ! -f Podfile ]; then
      pod init
    fi

    # Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ±Ğ»Ğ¾Ğº post_install, ĞµÑĞ»Ğ¸ ĞµĞ³Ğ¾ Ğ½ĞµÑ‚
    if ! grep -q "post_install do |installer|" Podfile; then
      cat <<EOT >> Podfile

post_install do |installer|
  installer.pods_project.targets.each do |target|
    target.build_configurations.each do |config|
      config.build_settings['EXCLUDED_ARCHS[sdk=iphonesimulator*]'] = 'x86_64'
    end
  end
end
EOT
    fi

    pod install
    cd ..


      - name: ğŸ—ï¸ Build iOS app for Simulator
        script: flutter build ios --simulator --debug

      - name: ğŸ“ Package Runner.app into .zip
        script: |
          mkdir -p build/ios/ipa
          zip -r build/ios/ipa/Runner.app.zip build/ios/iphonesimulator/Runner.app

    artifacts:
      - build/ios/ipa/Runner.app.zip
