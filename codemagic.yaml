workflows:
  ios-release-no-shorebird:
    name: iOS Release
    environment:
      flutter: stable
      xcode: latest

    scripts:
      - name: üîç Check Flutter environment
        script: flutter doctor -v

      - name: üì¶ Install dependencies
        script: flutter pub get

      - name: üßπ Clean previous builds
        script: flutter clean

      - name: üîß Ensure CocoaPods and exclude x86_64
        script: |
          cd ios
          if [ ! -f Podfile ]; then
            pod init
          fi

          # –°–æ–∑–¥–∞—ë–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª —Å —Å–æ–¥–µ—Ä–∂–∏–º—ã–º Podfile –±–µ–∑ –±–ª–æ–∫–∞ post_install
          grep -v "post_install do |installer|" Podfile > Podfile.tmp || true
          mv Podfile.tmp Podfile

          # –î–æ–±–∞–≤–ª—è–µ–º –Ω—É–∂–Ω—ã–π post_install –≤ –∫–æ–Ω–µ—Ü Podfile
          cat <<EOF >> Podfile

post_install do |installer|
  installer.pods_project.targets.each do |target|
    target.build_configurations.each do |config|
      config.build_settings['EXCLUDED_ARCHS[sdk=iphonesimulator*]'] = 'x86_64'
    end
  end
end
EOF

          pod install
          cd ..

      - name: üèóÔ∏è Build iOS app for Simulator
        script: flutter build ios --simulator --debug

      - name: üìÅ Package Runner.app into .zip
        script: |
          mkdir -p build/ios/ipa
          zip -r build/ios/ipa/Runner.app.zip build/ios/iphonesimulator/Runner.app

    artifacts:
      - build/ios/ipa/Runner.app.zip
